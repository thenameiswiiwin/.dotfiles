#!/usr/bin/env bash

set -euo pipefail
IFS=$'\n\t'

OS="$(uname -s)"
ARCH="$(uname -m)"

install_homebrew() {
    echo "Installing Homebrew..."

    if [[ "$ARCH" == "arm64" ]]; then
        BREW_PATH="/opt/homebrew/bin"
    else
        BREW_PATH="/usr/local/bin"
    fi

    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

    echo 'eval "$('$BREW_PATH'/brew shellenv)"' >>"$HOME/.zshrc"
    echo 'eval "$('$BREW_PATH'/brew shellenv)"' >>"$HOME/.bashrc"

    eval "$('$BREW_PATH'/brew shellenv)"
    echo "Homebrew installation complete!"
}

install_pacman_and_yay() {
    echo "Updating system and installing pacman dependencies..."
    sudo pacman -Syu --noconfirm base-devel git

    echo "Checking for yay..."
    if ! command -v yay &>/dev/null; then
        echo "Installing yay..."
        git clone https://aur.archlinux.org/yay-bin.git /tmp/yay-bin
        pushd /tmp/yay-bin >/dev/null || exit 1
        makepkg -si --noconfirm
        popd >/dev/null
        rm -rf /tmp/yay-bin
    fi

    echo "Pacman and Yay installation complete!"
}

install_chocolatey() {
    echo "Installing Chocolatey (Windows Package Manager)..."
    powershell.exe -NoProfile -InputFormat None -ExecutionPolicy Bypass -Command \
        "Set-ExecutionPolicy Bypass -Scope Process -Force; [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072; iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))"

    echo "Chocolatey installation complete!"
}

case "$OS" in
Darwin)
    echo "macOS detected. Checking for Homebrew..."
    if ! command -v brew &>/dev/null; then
        install_homebrew
    else
        echo "Homebrew is already installed."
    fi
    ;;
Linux)
    if [[ -f "/etc/arch-release" ]]; then
        echo "🐧 Arch Linux detected. Checking for Pacman & Yay..."
        install_pacman_and_yay
    else
        echo "Linux detected, but not Arch-based. Skipping package manager installation."
    fi
    ;;
MINGW* | MSYS* | CYGWIN*)
    echo "Windows detected. Checking for Chocolatey..."
    if ! powershell.exe -Command "choco -v" &>/dev/null; then
        install_chocolatey
    else
        echo "Chocolatey is already installed."
    fi
    ;;
*)
    echo "Unsupported OS: $OS. Skipping package manager installation."
    exit 1
    ;;
esac
