#!/usr/bin/env bash

set -e
set -o pipefail
set -u

OS="$(uname -s)"

if [[ "$OS" == "Darwin" ]]; then
    echo "macOS detected. Installing Ghostty via Homebrew..."
    brew install --cask ghostty
    echo "Ghostty installation complete!"
else
    echo "Linux detected. Installing Ghostty..."

    # Update and install required dependencies
    sudo apt update
    sudo apt install -y \
        llvm lld llvm-dev liblld-dev clang libclang-dev \
        libglib2.0-dev libgtk-4-dev libadwaita-1-dev \
        git wget xz-utils

    # Install Zig if not already installed
    ZIG_VERSION="0.13.0"
    ZIG_DIR="$HOME/.local/zig-linux-x86_64-$ZIG_VERSION"

    if ! command -v zig &>/dev/null; then
        echo "âš¡ Installing Zig $ZIG_VERSION..."
        wget "https://ziglang.org/download/$ZIG_VERSION/zig-linux-x86_64-$ZIG_VERSION.tar.xz" -O /tmp/zig.tar.xz
        mkdir -p "$HOME/.local"
        tar -xvf /tmp/zig.tar.xz -C "$HOME/.local"
        echo "export PATH=\"$ZIG_DIR:\$PATH\"" >>"$HOME/.bashrc"
        echo "export PATH=\"$ZIG_DIR:\$PATH\"" >>"$HOME/.zshrc"
        export PATH="$ZIG_DIR:$PATH"
    else
        echo "Zig is already installed."
    fi

    # Clone and build Ghostty
    GHOSTTY_DIR="$HOME/personal/ghostty"
    if [ ! -d "$GHOSTTY_DIR" ]; then
        git clone https://github.com/ghostty-org/ghostty.git "$GHOSTTY_DIR"
    fi

    echo "Building Ghostty..."
    pushd "$GHOSTTY_DIR" >/dev/null
    zig build -p "$HOME/.local" -Doptimize=ReleaseFast
    popd >/dev/null

    echo "Ghostty installation complete!"
fi
