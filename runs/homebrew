#!/usr/bin/env bash

set -e
set -o pipefail
set -u

OS="$(uname -s)"

if [[ "$OS" == "Darwin" ]]; then
    echo "macOS detected. Checking for Homebrew..."

    if ! command -v brew &>/dev/null; then
        echo "Homebrew not found. Installing Homebrew..."

        # Detect architecture (Apple Silicon or Intel)
        ARCH=$(uname -m)
        if [[ "$ARCH" == "arm64" ]]; then
            BREW_PATH="/opt/homebrew/bin"
            BREW_INSTALL_URL="https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh"
        else
            BREW_PATH="/usr/local/bin"
            BREW_INSTALL_URL="https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh"
        fi

        # Install Homebrew
        /bin/bash -c "$(curl -fsSL $BREW_INSTALL_URL)"

        # Add Homebrew to shell environment
        if [[ -f "$HOME/.zshrc" ]]; then
            echo "eval \"\$(${BREW_PATH}/brew shellenv)\"" >>"$HOME/.zshrc"
        fi
        if [[ -f "$HOME/.bashrc" ]]; then
            echo "eval \"\$(${BREW_PATH}/brew shellenv)\"" >>"$HOME/.bashrc"
        fi

        eval "$(${BREW_PATH}/brew shellenv)"
        echo "Homebrew installation complete!"
    else
        echo "Homebrew is already installed."
    fi
else
    echo "Not on macOS. Skipping Homebrew installation."
fi
