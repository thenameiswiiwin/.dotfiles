#!/usr/bin/env bash
set -e
set -o pipefail
set -u

echo "Installing Rust and Stylua..."

# Detect OS
OS="$(uname -s)"

install_rust() {
    if [[ "$OS" == "Darwin" ]]; then
        echo "Installing Rust via Homebrew..."
        brew install rust
    elif [[ "$OS" == "Linux" ]]; then
        echo "Installing Rust via rustup..."
        if ! command -v rustc &>/dev/null; then
            curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
            export PATH="$HOME/.cargo/bin:$PATH"
        else
            echo "Rust is already installed."
        fi
    elif [[ "$OS" =~ "MINGW" || "$OS" =~ "CYGWIN" || "$OS" == "Windows_NT" ]]; then
        echo "Windows detected. Installing Rust via Chocolatey..."
        powershell.exe -Command "& {choco install rust -y}"
    else
        echo "Unsupported OS: $OS"
        exit 1
    fi
}

install_stylua() {
    echo "ðŸ›  Installing Stylua..."
    if command -v cargo &>/dev/null; then
        cargo install stylua --features luajit
    else
        echo "Cargo not found! Ensure Rust is installed and 'cargo' is in PATH."
        exit 1
    fi
}

install_rust
install_stylua

echo "Rust and Stylua installation completed."
