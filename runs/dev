#!/usr/bin/env bash
set -euo pipefail
IFS=$'\n\t'

if command -v rustup &>/dev/null; then
    echo "rustup is already installed, skipping rustup installation."
elif command -v rustc &>/dev/null; then
    echo "Rust is already installed, skipping rustup installation to avoid conflicts."
else
    echo "Installing Rust via rustup..."
    curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
fi

echo "Configuring Git..."
git config --global user.email "huyn.nguyen95@gmail.com"
git config --global user.name "tnenameiswiiwin"

echo "Installing stylua via Cargo..."
cargo install stylua

# Install LuaRocks 3.11.0
LUAROCKS_VERSION="3.11.0"
LUAROCKS_TAR="/tmp/luarocks-${LUAROCKS_VERSION}.tar.gz"
LUAROCKS_URL="https://luarocks.org/releases/luarocks-${LUAROCKS_VERSION}.tar.gz"
LUAROCKS_DIR="/tmp/luarocks-${LUAROCKS_VERSION}"

echo "Downloading LuaRocks ${LUAROCKS_VERSION}..."
wget --output-document "$LUAROCKS_TAR" "$LUAROCKS_URL"

echo "Extracting LuaRocks..."
tar zxpf "$LUAROCKS_TAR" -C /tmp

echo "Building and installing LuaRocks..."
pushd "$LUAROCKS_DIR" >/dev/null || {
    echo "Failed to enter $LUAROCKS_DIR"
    exit 1
}
./configure && make && sudo make install
popd >/dev/null

# Clean up the downloaded tarball
rm -f "$LUAROCKS_TAR"

echo "Installing luacheck via LuaRocks..."
luarocks install luacheck

echo "Installation completed successfully."
