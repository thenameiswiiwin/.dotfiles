#!/usr/bin/env bash

set -e
set -o pipefail
set -u

echo "Checking Rust installation..."
if command -v rustup &>/dev/null; then
    echo "rustup is already installed, skipping installation."
elif command -v rustc &>/dev/null; then
    echo "Rust is already installed, skipping rustup installation to avoid conflicts."
else
    echo "Installing Rust via rustup..."
    curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
    export PATH="$HOME/.cargo/bin:$PATH"
fi

echo "Configuring Git..."
git config --global user.email "huyn.nguyen95@gmail.com"
git config --global user.name "tnenameiswiiwin"

# Ensure `cargo` is in PATH before installing packages
export PATH="$HOME/.cargo/bin:$PATH"

if ! command -v cargo &>/dev/null; then
    echo "Cargo is not found in PATH. Please restart your terminal or source ~/.cargo/env."
    exit 1
fi

echo "Installing stylua via Cargo..."
cargo install stylua --features luajit

# Install LuaRocks
LUAROCKS_VERSION="3.11.0"
LUAROCKS_TAR="/tmp/luarocks-${LUAROCKS_VERSION}.tar.gz"
LUAROCKS_URL="https://luarocks.org/releases/luarocks-${LUAROCKS_VERSION}.tar.gz"
LUAROCKS_DIR="/tmp/luarocks-${LUAROCKS_VERSION}"

echo "Downloading LuaRocks ${LUAROCKS_VERSION}..."
# wget --quiet --output-document "$LUAROCKS_TAR" "$LUAROCKS_URL"
curl -sL "$LUAROCKS_URL" -o "$LUAROCKS_TAR"

echo "Extracting LuaRocks..."
tar zxpf "$LUAROCKS_TAR" -C /tmp

echo "Building and installing LuaRocks..."
pushd "$LUAROCKS_DIR" >/dev/null || {
    echo "Failed to enter $LUAROCKS_DIR"
    exit 1
}
./configure && make -j$(nproc) && sudo make install
popd >/dev/null

# Clean up the downloaded tarball
rm -rf "$LUAROCKS_TAR" "$LUAROCKS_DIR"

echo "Installing luacheck via LuaRocks..."
luarocks install luacheck

echo "Installation completed successfully!"
