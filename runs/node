#!/usr/bin/env bash

set -e
set -o pipefail
set -u

echo "Installing Node.js, npm, pnpm, Deno, and Bun..."

OS="$(uname -s)"

install_node_mac() {
    echo "Detected macOS. Installing Node.js and pnpm via Homebrew..."
    if ! command -v brew &>/dev/null; then
        echo "Homebrew is not installed. Please install Homebrew first."
        exit 1
    fi
    brew install node pnpm
}

install_node_linux() {
    echo "Detected Linux. Installing Node.js and pnpm..."
    sudo apt update
    sudo apt install -y nodejs npm unzip curl

    # Configure npm to use a local prefix
    mkdir -p "$HOME/.local/npm"
    npm config set prefix "$HOME/.local/npm"

    # Install 'n' for managing Node versions
    npm install -g n
    n lts
}

install_node_windows() {
    echo "Detected Windows. Installing Node.js and pnpm via PowerShell..."

    if command -v scoop &>/dev/null; then
        scoop install nodejs pnpm
    elif command -v winget &>/dev/null; then
        winget install OpenJS.NodeJS
    else
        echo "Neither Scoop nor Winget is installed. Please install Node.js manually."
        exit 1
    fi
}

install_deno() {
    echo "Installing Deno..."
    curl -fsSL https://deno.land/install.sh | sh
}

install_bun() {
    echo "Installing Bun..."
    curl -fsSL https://bun.sh/install | bash
}

# Detect and install Node.js based on OS
case "$OS" in
Darwin)
    install_node_mac
    ;;
Linux)
    install_node_linux
    ;;
MINGW* | CYGWIN* | MSYS* | Windows_NT)
    install_node_windows
    ;;
*)
    echo "Unsupported OS: $OS"
    exit 1
    ;;
esac

# Install Deno & Bun
install_deno
install_bun

echo "Node.js, Deno, and Bun installation completed."
